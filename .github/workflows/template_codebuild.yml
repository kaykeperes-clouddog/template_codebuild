# Arquivo: template_codebuild/.github/workflows/template_codebuild.yml

name: Checkov Reutilizável - Validação de Segurança

on:
  workflow_call:

permissions:
  contents: read

jobs:
  checkov-scan:
    name: Run Checkov Security Scan
    runs-on: codebuild-checkov-validate-${{ github.run_id }}-${{ github.run_attempt }}

    steps:
      - name: Checkout do código (Do Repositório Chamador!)
        uses: actions/checkout@v4

      - name: Instalar Dependências (Checkov, JQ) 
        run: |
          pip install checkov
          yum install -y jq
          
      - name: Assumir Role da conta PRD e exportar credenciais
        run: |
          echo "Assumindo a role da conta PRD..."
          # 1. Pede o "crachá de visitante" (Assume Role)
          CREDS=$(aws sts assume-role \
                    --role-arn "arn:aws:iam::977919013454:role/clouddog-checkov-prd-role" \
                    --role-session-name "CheckovReusableWorkflowSession")
          
          # 2. Configura o AWS CLI para USAR esse crachá nos próximos passos
          echo "AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r .Credentials.AccessKeyId)" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r .Credentials.SecretAccessKey)" >> $GITHUB_ENV
          echo "AWS_SESSION_TOKEN=$(echo $CREDS | jq -r .Credentials.SessionToken)" >> $GITHUB_ENV
          echo "Credenciais temporárias prontas para os próximos passos."
      
      - name: Baixar arquivo de configuração CENTRAL do S3 (de PRD)
        run: |
          # Cria pasta separada para config central
          mkdir -p ./checkov_config_central 
          aws s3 cp s3://clouddog-checkov-prd-bucket/checkov/.checkov.yml ./checkov_config_central/.checkov.yml
          echo "Configuração central baixada."

      

      - name: Rodar análise de segurança (Usando apenas Config Central)
        run: |
          echo "Rodando scan do Checkov na pasta ./terraform usando APENAS a config CENTRAL do S3..."
          ls -la ${{ github.workspace }}/checkov_config_central # Debug para confirmar download

          # Comando final simplificado: Usa apenas o config file do S3
          checkov -d ./terraform --config-file ${{ github.workspace }}/checkov_policies/.checkov.ymll