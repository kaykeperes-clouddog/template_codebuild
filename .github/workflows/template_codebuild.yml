# Arquivo: template_codebuild/.github/workflows/template_codebuild.yml

name: Checkov Reutilizável - Validação de Segurança

on:
  workflow_call:

permissions:
  contents: read

jobs:
  checkov-scan:
    name: Run Checkov Security Scan
    runs-on: codebuild-checkov-validate-${{ github.run_id }}-${{ github.run_attempt }}

    steps:
      - name: Checkout do código (Do Repositório Chamador!)
        uses: actions/checkout@v4

      - name: Instalar Dependências (Checkov, JQ) 
        run: |
          pip install checkov
          yum install -y jq
          
      - name: Assumir Role da conta PRD e exportar credenciais
        run: |
          echo "Assumindo a role da conta PRD..."
          # 1. Pede o "crachá de visitante" (Assume Role)
          CREDS=$(aws sts assume-role \
                    --role-arn "arn:aws:iam::977919013454:role/clouddog-checkov-prd-role" \
                    --role-session-name "CheckovGitHubActionSession")
          
          # 2. Configura o AWS CLI para USAR esse crachá nos próximos passos
          #    Usamos $GITHUB_ENV para passar as variáveis entre os 'steps'
          echo "AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r .Credentials.AccessKeyId)" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r .Credentials.SecretAccessKey)" >> $GITHUB_ENV
          echo "AWS_SESSION_TOKEN=$(echo $CREDS | jq -r .Credentials.SessionToken)" >> $GITHUB_ENV
          echo "Credenciais temporárias prontas para os próximos passos."
      
      - name: Baixar regras customizadas do S3 (de PRD)
        run: |
          echo "Baixando regras da pasta /checkov/ do bucket S3 de PRD..."
          # Cria o diretório local que o seu comando checkov espera
          mkdir ./checkov_policies
          
          # Baixa o conteúdo da pasta 'checkov' do S3 para o diretório local
          # Este comando usa automaticamente as credenciais temporárias do passo anterior
          aws s3 cp s3://clouddog-checkov-prd-bucket/checkov/ ./checkov_policies --recursive
          echo "Regras baixadas."

      

      - name: Rodar análise de segurança
        run: |
          echo "Rodando scan do Checkov na pasta ./terraform usando config CENTRAL..."
          ls -la ${{ github.workspace }}/checkov_policies # Debug para confirmar download

          # Comando corrigido: Aponta para a pasta correta 'checkov_policies'
          checkov -d ./terraform \
                  --config-file ${{ github.workspace }}/checkov_policies/.checkov.yml
